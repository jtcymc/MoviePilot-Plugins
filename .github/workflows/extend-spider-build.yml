name: Extend Spider Build

on:
  push:
    paths:
      - 'package.json'
      - 'package.v2.json'
      - ".github/workflows/extend-spider-build.yml"
  repository_dispatch:
    types: [extend-spider-update]
  workflow_dispatch:
    inputs:
      some_input:
        description: "An example input"
        required: false
        default: "hello"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: yarn install

      - name: Prepare directories
        run: |
          # 确保 extendspider 目录存在
          mkdir -p plugins.v2/extendspider
          # 清理并创建 dist/assets 目录
          rm -rf plugins.v2/extendspider/dist
          mkdir -p plugins.v2/extendspider/dist/assets
          # 显示目录结构
          echo "Directory structure after preparation:"
          ls -la plugins.v2/extendspider/dist/assets/

      - name: Clone extend-spider component
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git clone https://${{ secrets.GH_TOKEN }}@github.com/jtcymc/extend-spider-moviepilot-plugin-component.git
          cd extend-spider-moviepilot-plugin-component
          yarn install
          yarn build
          # 显示构建后的文件
          echo "Built files in component:"
          ls -la dist/assets/
          cd ..

      - name: Copy federation files
        run: |
          echo "Current directory:"
          pwd
          echo "Listing source directory:"
          ls -la extend-spider-moviepilot-plugin-component/dist/assets/
          echo "Listing target directory before copy:"
          ls -la plugins.v2/extendspider/dist/assets/
          
          # 复制所有 federation 相关文件和目录
          if ! cp -rv extend-spider-moviepilot-plugin-component/dist/assets/__federation* plugins.v2/extendspider/dist/assets/; then
            echo "Error copying federation files"
            exit 1
          fi
          
          # 复制所有 vue export 相关文件
          if ! cp -rv extend-spider-moviepilot-plugin-component/dist/assets/_plugin-vue_export* plugins.v2/extendspider/dist/assets/; then
            echo "Error copying vue export files"
            exit 1
          fi
          
          # 复制 remoteEntry.js
          if ! cp -v extend-spider-moviepilot-plugin-component/dist/assets/remoteEntry.js plugins.v2/extendspider/dist/assets/; then
            echo "Error copying remoteEntry.js"
            exit 1
          fi
          
          # 显示复制后的目录结构
          echo "Directory structure after copying:"
          ls -la plugins.v2/extendspider/dist/assets/

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions@github.com'

      - name: Commit and push changes
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # 显示 git 状态
          echo "Git status before adding:"
          git status
          
          # 确保目录被跟踪
          if ! git add plugins.v2/extendspider/; then
            echo "Error adding extendspider directory"
            exit 1
          fi
          
          # 添加文件
          if ! git add plugins.v2/extendspider/dist/assets/; then
            echo "Error adding assets directory"
            exit 1
          fi
          
          # 显示 git 状态
          echo "Git status after adding:"
          git status
          
          # 检查是否有文件要提交
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # 提交并推送
          git commit -m "chore: update extend-spider federation files [skip ci]"
          git push https://${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq zip

      - name: Build and release changed plugins
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Track processed tags to avoid duplicates across package files
          : > processed_tags.txt

          process_package() {
            local pkg_file="$1"
            [ -f "$pkg_file" ] || return 0

            echo "Processing $pkg_file"

            # Extract entries with release == true: output format KEY|VERSION
            mapfile -t entries < <(jq -r 'to_entries | map(select(.value.release == true)) | .[] | "\(.key)|\(.value.version)"' "$pkg_file")

            if [ "${#entries[@]}" -eq 0 ]; then
              echo "No plugins with release=true in $pkg_file"
              return 0
            fi

            for entry in "${entries[@]}"; do
              plugin_id="${entry%%|*}"
              plugin_version="${entry##*|}"
              plugin_id_lc="$(echo "$plugin_id" | tr '[:upper:]' '[:lower:]')"

              dir1="plugins/${plugin_id_lc}"
              dir2="plugins.v2/${plugin_id_lc}"
              plugin_dir=""
              if [ -d "$dir1" ]; then plugin_dir="$dir1"; fi
              if [ -d "$dir2" ]; then plugin_dir="$dir2"; fi

              if [ -z "$plugin_dir" ]; then
                echo "WARN: directory for $plugin_id not found under plugins/ or plugins.v2/, skip."
                continue
              fi

              tag="${plugin_id}_v${plugin_version}"
              asset="${plugin_id_lc}_v${plugin_version}.zip"

              if grep -qxF "$tag" processed_tags.txt; then
                echo "Tag $tag already processed, skip."
                continue
              fi

              # Find previous tag for this plugin (any version)
              prev_tag="$(git tag --list "${plugin_id}_v*" --sort=-version:refname | head -n 1 || true)"

              changed=1
              if [ -n "$prev_tag" ]; then
                if git diff --quiet "$prev_tag" -- "$plugin_dir"; then
                  changed=0
                fi
              fi

              if [ "$changed" -eq 0 ]; then
                echo "No changes in $plugin_dir since $prev_tag, skip packaging $plugin_id."
                echo "$tag" >> processed_tags.txt
                continue
              fi

              echo "Packing $plugin_id from $plugin_dir -> $asset"
              rm -f "$asset"
              (cd "$(dirname "$plugin_dir")" && zip -r "$GITHUB_WORKSPACE/$asset" "$(basename "$plugin_dir")" -x "*/__pycache__/*" -x "*.pyc") >/dev/null

              # If same tag exists, delete release and both remote/local tag first
              if gh release view "$tag" >/dev/null 2>&1; then
                echo "Release $tag exists, deleting..."
                gh release delete "$tag" -y
                git push origin :refs/tags/"$tag" || true
              fi

              # Ensure no stale local tag remains
              git tag -d "$tag" >/dev/null 2>&1 || true

              echo "Creating release $tag"
              gh release create "$tag" "$asset" --title "$tag" --notes "Automated release of $plugin_id $plugin_version" --latest --target "$GITHUB_SHA"

              echo "$tag" >> processed_tags.txt
            done
          }

          process_package "package.json"
          process_package "package.v2.json"